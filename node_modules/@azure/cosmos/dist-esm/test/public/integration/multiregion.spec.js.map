{"version":3,"file":"multiregion.spec.js","sourceRoot":"","sources":["../../../../test/public/integration/multiregion.spec.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\nimport assert from \"assert\";\nimport { Suite } from \"mocha\";\n\nimport { CosmosClient } from \"../../../src\";\nimport { masterKey } from \"../common/_fakeTestSecrets\";\nimport { PluginOn, PluginConfig, CosmosClientOptions } from \"../../../src\";\n\nconst endpoint = \"https://failovertest.documents.azure.com/\";\n\n// This needs to be a function so the SDK plugin gets a fresh response each time and cannot mutate it\nconst databaseAccountResponse = {\n  headers: {\n    \"content-location\": \"https://failovertest.documents.azure.com/\",\n    \"content-type\": \"application/json\"\n  },\n  result: {\n    _self: \"\",\n    id: \"failovertest\",\n    _rid: \"failovertest.documents.azure.com\",\n    media: \"//media/\",\n    addresses: \"//addresses/\",\n    _dbs: \"//dbs/\",\n    writableLocations: [\n      {\n        name: \"East US\",\n        databaseAccountEndpoint: \"https://failovertest-eastus.documents.azure.com:443/\"\n      },\n      {\n        name: \"Australia East\",\n        databaseAccountEndpoint: \"https://failovertest-australiaeast.documents.azure.com:443/\"\n      }\n    ],\n    readableLocations: [\n      {\n        name: \"East US\",\n        databaseAccountEndpoint: \"https://failovertest-eastus.documents.azure.com:443/\"\n      },\n      {\n        name: \"Australia East\",\n        databaseAccountEndpoint: \"https://failovertest-australiaeast.documents.azure.com:443/\"\n      }\n    ],\n    enableMultipleWriteLocations: true,\n    userReplicationPolicy: {\n      asyncReplication: false,\n      minReplicaSetSize: 3,\n      maxReplicasetSize: 4\n    },\n    userConsistencyPolicy: {\n      defaultConsistencyLevel: \"Session\"\n    },\n    systemReplicationPolicy: {\n      minReplicaSetSize: 3,\n      maxReplicasetSize: 4\n    },\n    readPolicy: {\n      primaryReadCoefficient: 1,\n      secondaryReadCoefficient: 1\n    },\n    queryEngineConfiguration:\n      '{\"maxSqlQueryInputLength\":262144,\"maxJoinsPerSqlQuery\":5,\"maxLogicalAndPerSqlQuery\":500,\"maxLogicalOrPerSqlQuery\":500,\"maxUdfRefPerSqlQuery\":10,\"maxInExpressionItemsCount\":16000,\"queryMaxInMemorySortDocumentCount\":500,\"maxQueryRequestTimeoutFraction\":0.9,\"sqlAllowNonFiniteNumbers\":false,\"sqlAllowAggregateFunctions\":true,\"sqlAllowSubQuery\":true,\"sqlAllowScalarSubQuery\":true,\"allowNewKeywords\":true,\"sqlAllowLike\":false,\"sqlAllowGroupByClause\":true,\"maxSpatialQueryCells\":12,\"spatialMaxGeometryPointCount\":256,\"sqlAllowTop\":true,\"enableSpatialIndexing\":true}'\n  },\n  code: 200\n};\n\nconst collectionResponse = {\n  headers: {},\n  result: {\n    id: \"RegionalFailover6198\",\n    indexingPolicy: {\n      indexingMode: \"consistent\",\n      automatic: true,\n      includedPaths: [\n        {\n          path: \"/*\"\n        }\n      ],\n      excludedPaths: [\n        {\n          path: '/\"_etag\"/?'\n        }\n      ]\n    },\n    partitionKey: {\n      paths: [\"/_partitionKey\"],\n      kind: \"Hash\"\n    },\n    conflictResolutionPolicy: {\n      mode: \"LastWriterWins\",\n      conflictResolutionPath: \"/_ts\",\n      conflictResolutionProcedure: \"\"\n    },\n    geospatialConfig: {\n      type: \"Geography\"\n    },\n    _rid: \"kdY4AIn8g54=\",\n    _ts: 1572274839,\n    _self: \"dbs/kdY4AA==/colls/kdY4AIn8g54=/\",\n    _etag: '\"00007500-0000-0100-0000-5db702970000\"',\n    _docs: \"docs/\",\n    _sprocs: \"sprocs/\",\n    _triggers: \"triggers/\",\n    _udfs: \"udfs/\",\n    _conflicts: \"conflicts/\"\n  },\n  code: 200\n};\n\ndescribe(\"Multi-region tests\", function(this: Suite) {\n  this.timeout(process.env.MOCHA_TIMEOUT || \"30000\");\n\n  it(\"Preferred locations should be honored for readEndpoint\", async function() {\n    let requestIndex = 0;\n    let lastEndpointCalled = \"\";\n    const responses = [\n      databaseAccountResponse,\n      collectionResponse,\n      { code: 200, result: {}, headers: {} }\n    ];\n    const options: CosmosClientOptions = {\n      endpoint,\n      key: masterKey,\n      connectionPolicy: { preferredLocations: [\"Australia East\"] }\n    };\n    const plugins: PluginConfig[] = [\n      {\n        on: PluginOn.request,\n        plugin: async (context) => {\n          const response = responses[requestIndex];\n          lastEndpointCalled = context.endpoint;\n          requestIndex++;\n          if (response.code > 400) {\n            throw response;\n          }\n          return response;\n        }\n      }\n    ];\n    const client = new CosmosClient({\n      ...options,\n      plugins\n    } as any);\n    const currentReadEndpoint = await client.getReadEndpoint();\n    assert.equal(\n      currentReadEndpoint,\n      \"https://failovertest-australiaeast.documents.azure.com:443/\"\n    );\n    await client\n      .database(\"foo\")\n      .container(\"foo\")\n      .item(\"foo\", undefined)\n      .read();\n    assert.equal(lastEndpointCalled, \"https://failovertest-australiaeast.documents.azure.com:443/\");\n    client.dispose();\n  });\n\n  it(\"Preferred locations should be honored for writeEndpoint\", async function() {\n    let requestIndex = 0;\n    let lastEndpointCalled = \"\";\n    const responses = [\n      databaseAccountResponse,\n      collectionResponse,\n      { code: 201, result: {}, headers: {} }\n    ];\n    const options: CosmosClientOptions = {\n      endpoint,\n      key: masterKey,\n      connectionPolicy: { preferredLocations: [\"Australia East\"] }\n    };\n    const plugins: PluginConfig[] = [\n      {\n        on: PluginOn.request,\n        plugin: async (context) => {\n          const response = responses[requestIndex];\n          lastEndpointCalled = context.endpoint;\n          requestIndex++;\n          if (response.code > 400) {\n            throw response;\n          }\n          return response;\n        }\n      }\n    ];\n    const client = new CosmosClient({\n      ...options,\n      plugins\n    } as any);\n    const writeEndpoint = await client.getWriteEndpoint();\n    assert.equal(writeEndpoint, \"https://failovertest-australiaeast.documents.azure.com:443/\");\n    await client\n      .database(\"foo\")\n      .container(\"foo\")\n      .items.upsert({ id: \"foo\", _partitionKey: \"bar\" });\n    assert.equal(lastEndpointCalled, \"https://failovertest-australiaeast.documents.azure.com:443/\");\n    client.dispose();\n  });\n});\n"]}